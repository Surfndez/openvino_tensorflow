 resources:
  repositories:
  - repository: openvino_tensorflow
    type: github
    endpoint: openvinotoolkit
    name: openvinotoolkit/openvino_tensorflow
    
 pool:
  name: 'Perf'
  
 variables:
    WORK_DIR: $(Pipeline.Workspace)/openvino_tensorflow
    OV_LOCATION: /opt/intel/openvino_2021.3.394/
    RUN_TYPE: 'ovtf_abi0_cpu,ovtf_abi0_igpu,ovtf_abi0_myriad'
    MODELS_DIR: /home/iotgecsp/ci_models
    JOB_DIR: /home/iotgecsp/azu_ag/myagent/jenkins_scripts
    TF_PATH: /home/iotgecsp/tf_source/tf_2_5_0
    
 steps:
 
   - checkout: self
     clean: true
     lfs: false
     path: openvino_tensorflow
 
   - script: |
      echo $(WORK_DIR)
      git submodule init
      git submodule update
      python3 build_ovtf.py --use_tensorflow_from_location=${TF_PATH} --cxx11_abi_version=0
     workingDirectory: $(WORK_DIR) 
     displayName: "Build"
     
   - script: |
      bash auto_perf.sh $RUN_TYPE $MODELS_DIR $JOB_DIR $WORK_DIR &> perflog.txt
      python3 validate_perf.py ref_ovtfvsperf_report.xlsx ; if [[ $? == 1 ]]; \
      then echo "Build step success"; else echo "Build step failed ";exit 1; fi
     workingDirectory: $(JOB_DIR) 
     displayName: "Perf Tests"
     
   - script: |
      rm -rf *
     displayName: "Cleanup"   
     workingDirectory: $(WORK_DIR)
